{% extends "base.html" %} {% block title %}{{ exam.title }} - Online Exam
Portal{% endblock %} {% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h4 class="mb-0">{{ exam.title }}</h4>
          <div class="timer bg-danger text-white px-3 py-2 rounded">
            Time Remaining: <span id="time">00:00:00</span>
          </div>
        </div>

        <div class="card-body">
          <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
          </div>

          <form method="POST" id="examForm">
            {% for question in questions %}
            <div class="question mb-4" id="question-{{ question.id }}">
              <h5>Question {{ loop.index }} ({{ question.marks }} marks)</h5>
              <p>{{ question.question_text }}</p>

              {% set order = option_order[question.id] %} {% for opt in order %}
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="radio"
                  name="question_{{ question.id }}"
                  value="{{ opt }}"
                  required
                />
                <label class="form-check-label">
                  {{ opt }}) {{ attribute(question, 'option_' + opt|lower) }}
                </label>
              </div>
              {% endfor %}
            </div>
            {% endfor %}

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                Submit Exam
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {

    let timeRemaining = {{ remaining_seconds }};

    function updateTimer() {
      const h = Math.floor(timeRemaining / 3600);
      const m = Math.floor((timeRemaining % 3600) / 60);
      const s = timeRemaining % 60;

      document.getElementById('time').textContent =
        `${h.toString().padStart(2,'0')}:` +
        `${m.toString().padStart(2,'0')}:` +
        `${s.toString().padStart(2,'0')}`;

      if (timeRemaining <= 0) {
        document.getElementById('examForm').submit();
      } else {
        timeRemaining--;
        setTimeout(updateTimer, 1000);
      }
    }

    updateTimer();

    const total = {{ questions|length }};
    let answered = 0;

    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const qid = this.name.split('_')[1];
        const div = document.getElementById('question-' + qid);
        if (!div.classList.contains('answered')) {
          div.classList.add('answered');
          answered++;
          document.getElementById('progressBar').style.width =
            ((answered / total) * 100) + '%';
        }
      });
    });

    window.onbeforeunload = function () {
      return "Are you sure you want to leave? Your progress will be lost.";
    };
  });
</script>
{% endblock %}
