{% extends "base.html" %} {% block title %}Manage Users - Online Exam Portal{%
endblock %} {% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Manage Users</h1>
    <div>
      <button
        type="button"
        class="btn btn-secondary me-2"
        data-bs-toggle="modal"
        data-bs-target="#bulkUploadModal"
      >
        <i class="fas fa-file-csv"></i> Bulk Upload Users
      </button>

      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#addUserModal"
      >
        <i class="fas fa-user-plus"></i> Add New User
      </button>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %} {% for category, message in messages %}
  <div
    class="alert alert-{{ category }} alert-dismissible fade show"
    role="alert"
  >
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %} {% endif %} {% endwith %}

  <!-- Users Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Joined Date</th>
              <th>Exams Taken</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
              <td>{{ user.exams_taken|length }}</td>
              <td>
                {% if user.is_admin %}
                <span class="badge bg-primary">Admin</span>
                {% else %}
                <span class="badge bg-success">Student</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a
                    href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                    class="btn btn-warning"
                  >
                    <i class="fas fa-edit"></i> Edit
                  </a>
                  <a
                    href="{{ url_for('admin.assign_exam', user_id=user.id) }}"
                    class="btn btn-info"
                  >
                    <i class="fas fa-tasks"></i> Assign
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- Add Single User Modal -->
<!-- ========================= -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body">
        <form method="POST" action="{{ url_for('admin.admin_users') }}">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" name="username" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <input
              type="password"
              name="password"
              class="form-control"
              required
            />
          </div>

          <div class="form-check mb-3">
            <input
              type="checkbox"
              class="form-check-input"
              name="is_admin"
              id="is_admin"
            />
            <label class="form-check-label" for="is_admin">
              Admin Privileges
            </label>
          </div>

          <button type="submit" class="btn btn-primary w-100">Add User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- Bulk Upload Modal -->
<!-- ========================= -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bulk Upload Users (CSV)</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body">
        <form method="POST" action="#" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">Upload CSV File</label>
            <input
              type="file"
              name="csv_file"
              class="form-control"
              accept=".csv"
              required
            />
          </div>

          <div class="alert alert-info">
            <strong>CSV Columns Required:</strong>
            <ul class="mb-0">
              <li>username</li>
              <li>email</li>
              <li>password</li>
            </ul>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            Upload & Import Users
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
